// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  MANAGER
  ADMIN
  WORKER
}

enum POLStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProductType {
  PLAIN
  DECOR
  HAND_BUILT
  SLAB_TRAY
}

enum ProductionStage {
  // Forming stages
  THROWING
  TRIMMING
  DECORATION
  DRYING
  LOAD_BISQUE
  
  // Firing stages
  OUT_BISQUE
  LOAD_HIGH_FIRING
  OUT_HIGH_FIRING
  LOAD_RAKU_FIRING
  OUT_RAKU_FIRING
  LOAD_LUSTER_FIRING
  OUT_LUSTER_FIRING
  
  // Glazing stages
  SANDING
  WAXING
  DIPPING
  SPRAYING
  COLOR_DECORATION
  
  // QC stages
  QC_GOOD
  QC_REJECT
  QC_RE_FIRING
  QC_SECOND
}

enum AlertPriority {
  CRITICAL
  WARNING
  INFORMATIONAL
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
}

enum IssueType {
  MATERIAL_ISSUE
  TOOL_ISSUE
  PROCESS_ISSUE
  QUALITY_ISSUE
  OTHER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LogStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum RevisionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum RevisionType {
  DESIGN_CHANGE
  MATERIAL_CHANGE
  PROCESS_CHANGE
  OTHER
}

// User table
model User {
  id            String    @id @default(uuid())
  username       String    @unique
  email          String?   @unique @map("email")
  passwordHash   String?   @map("password")
  fullName       String?   @map("fullName")
  role           UserRole  @default(WORKER)
  createdAt      DateTime   @default(now()) @map("createdAt")
  updatedAt      DateTime?   @map("updatedAt")
  lastLogin      DateTime?  @map("lastLogin")
  isActive       Boolean    @default(true) @map("is_active")
  
  // Relationships
  pols                  POL[]              @relation("POLCreatedBy")
  productionRecords    ProductionRecord[]
  logbookEntries       LogbookEntry[]
  revisionTickets      RevisionTicket[]     @relation("RevisionCreatedBy")
  approvedRevisions    RevisionTicket[]     @relation("RevisionApprovedBy")
  activityLogs         ActivityLog[]
  reportedAlerts       DiscrepancyAlert[] @relation("AlertReportedBy")
  acknowledgedAlerts   DiscrepancyAlert[] @relation("AlertAcknowledgedBy")
  resolvedAlerts        DiscrepancyAlert[] @relation("AlertResolvedBy")
  
  @@map("users")
}

// POL (Purchase Order List) table
model POL {
  id            String     @id @default(uuid())
  poNumber      String     @unique @map("polNumber")
  clientName    String     @map("customerName")
  poDate        DateTime   @default(now()) @map("orderDate")
  deliveryDate  DateTime   @map("deliveryDate")
  status        POLStatus  @default(DRAFT)
  notes         String?    @map("notes")
  createdBy     String     @map("createdBy")
  createdAt      DateTime   @default(now()) @map("createdAt")
  updatedAt      DateTime   @updatedAt @map("updatedAt")
  
  // Relationships
  creator               User?              @relation("POLCreatedBy", fields: [createdBy], references: [id])
  polDetails           POLDetail[]
  logbookEntries       LogbookEntry[]
  revisionTickets      RevisionTicket[]
  discrepancyAlerts   DiscrepancyAlert[]
  
  @@map("pols")
}

// POL Detail table (products within a POL)
model POLDetail {
  id             String      @id @default(uuid())
  polId          String      @map("pol_id")
  productCode     String      @map("product_code")
  productName     String      @map("product_name")
  quantity       Int
  extraBuffer     Int         @default(15) @map("extra_buffer") // Percentage
  productType     ProductType @default(PLAIN) @map("product_type")
  color          String?
  texture        String?
  material       String?
  size           String?
  finalSize      String?     @map("final_size")
  notes          String?
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  // Relationships
  pol                   POL                 @relation(fields: [polId], references: [id], onDelete: Cascade)
  productionRecords    ProductionRecord[]
  decorationTasks      DecorationTask[]
  discrepancyAlerts   DiscrepancyAlert[]
  logbookEntries       LogbookEntry[]
  revisionTickets      RevisionTicket[]
  
  @@map("pol_details")
}

// Production Record table
model ProductionRecord {
  id              String          @id @default(uuid())
  polDetailId      String          @map("pol_detail_id")
  stage           ProductionStage
  quantity        Int
  rejectQuantity  Int             @default(0) @map("reject_quantity")
  remakeCycle     Int             @default(0) @map("remake_cycle")
  notes           String?
  createdBy        String          @map("created_by")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  
  // Relationships
  polDetail    POLDetail  @relation(fields: [polDetailId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [createdBy], references: [id])
  
  @@map("production_records")
}

// Decoration Task table
model DecorationTask {
  id                String   @id @default(uuid())
  polDetailId        String   @map("pol_detail_id")
  taskName          String   @map("task_name")
  taskDescription  String?  @map("task_description")
  quantityRequired  Int      @default(0) @map("quantity_required")
  quantityCompleted Int      @default(0) @map("quantity_completed")
  quantityRejected  Int      @default(0) @map("quantity_rejected")
  status            String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  notes             String?
  createdBy          String?  @map("created_by")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  
  // Relationships
  polDetail POLDetail @relation(fields: [polDetailId], references: [id], onDelete: Cascade)
  
  @@map("decoration_tasks")
}

// Discrepancy Alert table
model DiscrepancyAlert {
  id               String        @id @default(uuid())
  polId            String        @map("pol_id")
  polDetailId       String        @map("pol_detail_id")
  stage            ProductionStage
  expectedQuantity  Int           @map("expected_quantity")
  actualQuantity    Int           @map("actual_quantity")
  difference        Int
  alertType        String        @map("alert_type")
  alertMessage     String        @map("alert_message")
  priority         AlertPriority @default(WARNING)
  status           AlertStatus   @default(OPEN)
  reportedBy       String        @map("reported_by")
  acknowledgedBy   String?       @map("acknowledged_by")
  acknowledgedAt   DateTime?     @map("acknowledged_at")
  resolvedBy        String?       @map("resolved_by")
  resolvedAt        DateTime?     @map("resolved_at")
  resolutionNotes   String?       @map("resolution_notes")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  // Relationships
  pol               POL         @relation(fields: [polId], references: [id], onDelete: Cascade)
  polDetail          POLDetail  @relation(fields: [polDetailId], references: [id], onDelete: Cascade)
  reportedByUser     User        @relation("AlertReportedBy", fields: [reportedBy], references: [id])
  acknowledgedByUser User?       @relation("AlertAcknowledgedBy", fields: [acknowledgedBy], references: [id])
  resolvedByUser     User?       @relation("AlertResolvedBy", fields: [resolvedBy], references: [id])
  
  @@map("discrepancy_alerts")
}

// Logbook Entry table
model LogbookEntry {
  id            String      @id @default(uuid())
  polId         String?     @map("pol_id")
  polDetailId    String?     @map("pol_detail_id")
  stage          String?
  issueType      IssueType    @map("issue_type")
  description     String
  severity       Severity
  resolution     String?
  status         LogStatus   @default(OPEN)
  createdBy       String      @map("created_by")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  // Relationships
  pol           POL?        @relation(fields: [polId], references: [id])
  polDetail      POLDetail?  @relation(fields: [polDetailId], references: [id])
  user          User        @relation(fields: [createdBy], references: [id])
  
  @@map("logbook_entries")
}

// Revision Ticket table
model RevisionTicket {
  id                String          @id @default(uuid())
  ticketNumber       String          @unique @map("ticket_number")
  polId             String          @map("pol_id")
  polDetailId        String?         @map("pol_detail_id")
  createdBy          String          @map("created_by")
  revisionType      RevisionType    @map("revision_type")
  issueType         String          @map("issue_type")
  severity           Severity
  description        String
  reason             String
  impactAssessment  String?         @map("impact_assessment")
  status             RevisionStatus   @default(DRAFT)
  submittedAt        DateTime?       @map("submitted_at")
  approvedBy         String?         @map("approved_by")
  approvedAt         DateTime?       @map("approved_at")
  managerNotes       String?         @map("manager_notes")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  
  // Relationships
  pol               POL         @relation(fields: [polId], references: [id])
  polDetail         POLDetail?  @relation(fields: [polDetailId], references: [id])
  creator           User        @relation("RevisionCreatedBy", fields: [createdBy], references: [id])
  approvedByUser    User?       @relation("RevisionApprovedBy", fields: [approvedBy], references: [id])
  
  @@map("revision_tickets")
}

// Activity Log table (for audit)
model ActivityLog {
  id          String   @id @default(uuid())
  userId       String   @map("user_id")
  action      String
  entityType  String   @map("entity_type")
  entityId    String?   @map("entity_id")
  details     String?
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relationships
  user User @relation(fields: [userId], references: [id])
  
  @@map("activity_logs")
}
